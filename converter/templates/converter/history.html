{% extends "converter/base.html" %}

{% block title %}History - PDF to Markdown{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <h1 class="text-2xl font-bold text-gray-900">Conversion History</h1>
    <a href="{% url 'converter:index' %}"
       class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold
              rounded-lg shadow-sm hover:bg-indigo-700 transition-colors w-fit">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      New Conversion
    </a>
  </div>

  <form method="get" action="{% url 'converter:history' %}" class="max-w-md">
    <label for="history-search" class="sr-only">Search by file name</label>
    <div class="relative">
      <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </span>
      <input type="search" id="history-search" name="q" value="{{ search_query }}"
             placeholder="Search by file name"
             class="block w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm
                    focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      <button type="submit" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
        <span class="sr-only">Search</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </button>
    </div>
  </form>

  {% if tasks %}
  <form method="post" action="{% url 'converter:history_bulk_delete' %}" id="history-bulk-form">
    {% csrf_token %}
    <input type="hidden" name="q" value="{{ search_query }}">
    <div class="flex items-center gap-4 mb-4">
      <button type="submit" id="bulk-delete-btn" disabled
              class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white text-sm font-semibold
                     rounded-lg shadow-sm hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        Delete selected
      </button>
      <span id="selected-count" class="text-sm text-gray-500">0 selected</span>
    </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="select-all" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                     aria-label="Select all">
            </label>
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Pages</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Time</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Backend</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for task in tasks %}
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-4 py-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" name="ids" value="{{ task.pk }}" class="row-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                     aria-label="Select {{ task.original_filename }}">
            </label>
          </td>
          <td class="px-6 py-4 text-sm font-medium text-gray-900 max-w-[200px] truncate">
            {{ task.original_filename }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            {% if task.effective_status == "success" %}
              {% include "converter/_status_badge.html" with status=task.effective_status label="Success" %}
            {% elif task.effective_status == "partial_success" %}
              {% include "converter/_status_badge.html" with status=task.effective_status label="Partially OK" %}
            {% elif task.effective_status == "failed" %}
              {% include "converter/_status_badge.html" with status=task.effective_status label="Failed" %}
            {% elif task.status == "processing" %}
              {% include "converter/_status_badge.html" with status="processing" label="Processing" %}
            {% else %}
              {% include "converter/_status_badge.html" with status=task.effective_status label="Pending" %}
            {% endif %}
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 hidden sm:table-cell">
            {% if task.page_count %}{{ task.pages_processed }}/{{ task.page_count }}{% else %}&mdash;{% endif %}
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 hidden sm:table-cell">
            {% if task.processing_time_seconds %}{{ task.processing_time_seconds|floatformat:1 }}s{% else %}&mdash;{% endif %}
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 hidden md:table-cell">
            {% if task.vision_backend %}{{ task.vision_backend }}{% else %}&mdash;{% endif %}
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 whitespace-nowrap">
            {{ task.created_at|date:"M d, Y H:i" }}
          </td>
          <td class="px-6 py-4 text-right text-sm whitespace-nowrap space-x-2">
            <a href="{% url 'converter:download_pdf' pk=task.pk %}"
               class="text-gray-500 hover:text-gray-700 font-medium">PDF</a>
            {% if task.effective_status == "success" or task.effective_status == "partial_success" %}
              <a href="{% url 'converter:result' pk=task.pk %}"
                 class="text-indigo-600 hover:text-indigo-800 font-medium">View</a>
              <a href="{% url 'converter:download' pk=task.pk %}"
                 class="text-gray-500 hover:text-gray-700 font-medium">Download</a>
            {% elif task.status == "processing" %}
              <a href="{% url 'converter:processing' pk=task.pk %}"
                 class="text-blue-600 hover:text-blue-800 font-medium">Progress</a>
            {% elif task.status == "failed" %}
              <a href="{% url 'converter:result' pk=task.pk %}"
                 class="text-red-600 hover:text-red-800 font-medium">Details</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </form>
  <script>
    (function() {
      var form = document.getElementById('history-bulk-form');
      var selectAll = document.getElementById('select-all');
      var rowCheckboxes = form.querySelectorAll('.row-checkbox');
      var bulkDeleteBtn = document.getElementById('bulk-delete-btn');
      var selectedCountEl = document.getElementById('selected-count');

      function updateState() {
        var checked = form.querySelectorAll('.row-checkbox:checked');
        var n = checked.length;
        bulkDeleteBtn.disabled = n === 0;
        selectedCountEl.textContent = n + ' selected';
        selectAll.indeterminate = n > 0 && n < rowCheckboxes.length;
        selectAll.checked = n === rowCheckboxes.length && rowCheckboxes.length > 0;
      }

      selectAll.addEventListener('change', function() {
        rowCheckboxes.forEach(function(cb) { cb.checked = selectAll.checked; });
        updateState();
      });

      rowCheckboxes.forEach(function(cb) {
        cb.addEventListener('change', updateState);
      });

      updateState();
    })();
  </script>
  {% else %}
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    {% if search_query %}
    <h3 class="text-lg font-medium text-gray-900 mb-1">No matching files</h3>
    <p class="text-gray-500 mb-4">No conversions match "{{ search_query }}". Try a different search or clear the search.</p>
    <a href="{% url 'converter:history' %}"
       class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 text-sm font-semibold
              rounded-lg hover:bg-gray-200 transition-colors">
      Clear search
    </a>
    {% else %}
    <h3 class="text-lg font-medium text-gray-900 mb-1">No conversions yet</h3>
    <p class="text-gray-500 mb-4">Upload your first PDF to get started.</p>
    <a href="{% url 'converter:index' %}"
       class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-semibold
              rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">
      Upload PDF
    </a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
